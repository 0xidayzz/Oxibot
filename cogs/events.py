"""
Gestion des √©v√©nements Discord
"""

import discord
from discord.ext import commands
from datetime import datetime
import config

class Events(commands.Cog):
    def __init__(self, bot, db_manager, spotify_client):
        self.bot = bot
        self.db = db_manager
        self.spotify = spotify_client
    
    @commands.Cog.listener()
    async def on_ready(self):
        """√âv√©nement d√©clench√© quand le bot est pr√™t"""
        print(f'‚úÖ √âv√©nements charg√©s - Bot actif sur {len(self.bot.guilds)} serveur(s)')
    
    @commands.Cog.listener()
    async def on_guild_join(self, guild):
        """√âv√©nement d√©clench√© quand le bot rejoint un serveur"""
        print(f'üì• Bot ajout√© au serveur: {guild.name} (ID: {guild.id})')
        
        # Cr√©er la configuration pour ce serveur
        conn = self.db.get_connection()
        cursor = conn.cursor()
        cursor.execute("""
            INSERT IGNORE INTO config (guild_id)
            VALUES (%s)
        """, (guild.id,))
        conn.commit()
        cursor.close()
        conn.close()
        
        # Envoyer un message de bienvenue dans le premier channel texte disponible
        for channel in guild.text_channels:
            if channel.permissions_for(guild.me).send_messages:
                embed = discord.Embed(
                    title="üéµ Merci de m'avoir ajout√© !",
                    description=(
                        "Je suis ton assistant de suivi Spotify personnel !\n\n"
                        "**Premi√®res √©tapes :**\n"
                        "1Ô∏è‚É£ Utilise `/setchannel` pour configurer les salons\n"
                        "2Ô∏è‚É£ Lance de la musique sur Spotify\n"
                        "3Ô∏è‚É£ Je commencerai automatiquement √† suivre tes √©coutes !\n\n"
                        "**Commandes utiles :**\n"
                        "‚Ä¢ `/wrapped` - Ton r√©capitulatif d'√©coute\n"
                        "‚Ä¢ `/graph` - Visualise tes statistiques\n"
                        "‚Ä¢ `/song` - Titre en cours\n"
                        "‚Ä¢ `/top` - Tes tops titres/artistes\n"
                        "‚Ä¢ `/info` - Infos sur un titre/artiste\n\n"
                        "**Fonctionnalit√©s automatiques :**\n"
                        "üéß D√©tection des titres en temps r√©el\n"
                        "‚ú® Notifications de nouvelles sorties\n"
                        "üèÜ Paliers et achievements\n"
                        "üìä Wrapped hebdomadaires automatiques\n\n"
                        "Commence √† √©couter et profite ! üé∂"
                    ),
                    color=config.DEFAULT_THEME['color']
                )
                embed.set_footer(text="Utilise /help pour plus d'informations")
                
                try:
                    await channel.send(embed=embed)
                    break
                except:
                    continue
    
    @commands.Cog.listener()
    async def on_guild_remove(self, guild):
        """√âv√©nement d√©clench√© quand le bot quitte un serveur"""
        print(f'üì§ Bot retir√© du serveur: {guild.name} (ID: {guild.id})')
        
        # Optionnel : Supprimer la configuration du serveur
        # conn = self.db.get_connection()
        # cursor = conn.cursor()
        # cursor.execute("DELETE FROM config WHERE guild_id = %s", (guild.id,))
        # conn.commit()
        # cursor.close()
        # conn.close()
    
    @commands.Cog.listener()
    async def on_command_error(self, ctx, error):
        """Gestion globale des erreurs de commandes"""
        if isinstance(error, commands.CommandNotFound):
            return
        
        if isinstance(error, commands.MissingPermissions):
            embed = discord.Embed(
                title="‚ùå Permissions insuffisantes",
                description="Tu n'as pas les permissions n√©cessaires pour cette commande.",
                color=0xFF0000
            )
            await ctx.send(embed=embed, ephemeral=True)
            return
        
        if isinstance(error, commands.BotMissingPermissions):
            embed = discord.Embed(
                title="‚ùå Permissions bot insuffisantes",
                description="Je n'ai pas les permissions n√©cessaires pour effectuer cette action.",
                color=0xFF0000
            )
            await ctx.send(embed=embed, ephemeral=True)
            return
        
        if isinstance(error, commands.CommandOnCooldown):
            embed = discord.Embed(
                title="‚è∞ Cooldown actif",
                description=f"Cette commande est en cooldown. R√©essaye dans {error.retry_after:.1f}s",
                color=0xFFA500
            )
            await ctx.send(embed=embed, ephemeral=True)
            return
        
        # Erreur non g√©r√©e
        print(f'‚ùå Erreur non g√©r√©e: {error}')
        embed = discord.Embed(
            title="‚ùå Erreur",
            description=f"Une erreur inattendue s'est produite : `{error}`",
            color=0xFF0000
        )
        embed.set_footer(text="Si l'erreur persiste, contacte le d√©veloppeur")
        
        try:
            await ctx.send(embed=embed, ephemeral=True)
        except:
            pass
    
    @commands.Cog.listener()
    async def on_app_command_error(self, interaction: discord.Interaction, error):
        """Gestion des erreurs pour les commandes slash"""
        if isinstance(error, discord.app_commands.CommandOnCooldown):
            embed = discord.Embed(
                title="‚è∞ Cooldown actif",
                description=f"Cette commande est en cooldown. R√©essaye dans {error.retry_after:.1f}s",
                color=0xFFA500
            )
            
            if interaction.response.is_done():
                await interaction.followup.send(embed=embed, ephemeral=True)
            else:
                await interaction.response.send_message(embed=embed, ephemeral=True)
            return
        
        if isinstance(error, discord.app_commands.MissingPermissions):
            embed = discord.Embed(
                title="‚ùå Permissions insuffisantes",
                description="Tu n'as pas les permissions n√©cessaires pour cette commande.",
                color=0xFF0000
            )
            
            if interaction.response.is_done():
                await interaction.followup.send(embed=embed, ephemeral=True)
            else:
                await interaction.response.send_message(embed=embed, ephemeral=True)
            return
        
        # Erreur non g√©r√©e
        print(f'‚ùå Erreur commande slash: {error}')
        embed = discord.Embed(
            title="‚ùå Erreur",
            description=f"Une erreur s'est produite : `{error}`",
            color=0xFF0000
        )
        
        try:
            if interaction.response.is_done():
                await interaction.followup.send(embed=embed, ephemeral=True)
            else:
                await interaction.response.send_message(embed=embed, ephemeral=True)
        except:
            pass
    
    @commands.Cog.listener()
    async def on_message(self, message):
        """√âv√©nement d√©clench√© √† chaque message"""
        # Ignorer les messages du bot
        if message.author.bot:
            return
        
        # Traiter les commandes normalement
        await self.bot.process_commands(message)
    
    @commands.Cog.listener()
    async def on_member_join(self, member):
        """√âv√©nement d√©clench√© quand un membre rejoint le serveur"""
        # Cette fonction peut √™tre utilis√©e pour envoyer un message de bienvenue
        # ou initialiser des donn√©es sp√©cifiques √† l'utilisateur
        pass
    
    @commands.Cog.listener()
    async def on_member_remove(self, member):
        """√âv√©nement d√©clench√© quand un membre quitte le serveur"""
        # Cette fonction peut √™tre utilis√©e pour nettoyer les donn√©es
        pass

async def setup(bot):
    db_manager = bot.db_manager
    spotify_client = bot.spotify_client
    await bot.add_cog(Events(bot, db_manager, spotify_client))